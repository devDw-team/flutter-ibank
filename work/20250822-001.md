# 작업 내역 - 2025년 8월 22일

## 작업 요약
- Flutter IBank 그룹웨어 앱의 할일 관리 및 프로젝트 관리 기능 개선
- 주요 버그 수정 및 새로운 기능 추가

---

## 1. 할일 삭제 기능 버그 수정

### 문제점
- 할일 상세 화면에서 삭제 버튼 클릭 시 "Task not found or already deleted" 오류 발생
- 삭제 권한이 있음에도 불구하고 삭제가 되지 않는 문제

### 원인
- tasks 테이블에 DELETE RLS 정책이 없었음
- 삭제 쿼리 로직의 문제

### 해결 방법

#### 1.1 DELETE RLS 정책 추가
```sql
-- Add DELETE policy for tasks table
CREATE POLICY "Users can delete own or assigned tasks" ON tasks
FOR DELETE
USING (
  auth.uid() = user_id 
  OR auth.uid() = assigned_by 
  OR (
    EXISTS (
      SELECT 1 
      FROM project_members 
      WHERE project_members.project_id = tasks.project_id 
      AND project_members.user_id = auth.uid() 
      AND project_members.role IN ('owner', 'admin')
    )
  )
);
```

#### 1.2 Repository 메서드 개선
- `lib/features/tasks/data/repositories/task_repository.dart`
  - deleteTask 메서드 수정: 태스크 존재 여부 확인 후 삭제
  - 명확한 에러 메시지 제공

#### 1.3 Provider 수정
- `lib/features/tasks/presentation/providers/task_provider.dart`
  - 삭제 후 프로젝트별 tasks provider도 invalidate하도록 수정

---

## 2. 프로젝트 목록 필터링 버그 수정

### 문제점
- 프로젝트 목록에서 상태별 필터링 후 "전체" 선택 시 필터가 초기화되지 않음
- PopupMenuButton의 onSelected 콜백이 같은 값 선택 시 호출되지 않는 문제

### 해결 방법

#### 2.1 PopupMenuButton 타입 변경
- `lib/features/projects/presentation/screens/projects_screen.dart`
  - `PopupMenuButton<ProjectStatus?>` → `PopupMenuButton<String>`으로 변경
  - 각 메뉴 아이템에 고유한 문자열 값 할당
  - "all" 문자열을 null로 매핑하여 전체 필터 구현

#### 2.2 Provider 로직 개선
- `lib/features/projects/presentation/providers/project_provider.dart`
  - filteredProjectsProvider의 AsyncValue 처리 방식 개선
  - 명시적인 상태 처리로 일관된 동작 보장

---

## 3. 할일 관리 "검수" 상태 추가

### 요구사항
- 할일 관리에 "검수" 상태 추가
- 칸반보드에서 진행중 다음에 검수 컬럼 표시

### 구현 내용

#### 3.1 데이터베이스 마이그레이션
```sql
-- Add 'review' status to tasks table
COMMENT ON COLUMN tasks.status IS 'Task status: pending, in_progress, review, completed, on_hold, cancelled';

-- Update CHECK constraint
ALTER TABLE tasks 
DROP CONSTRAINT IF EXISTS tasks_status_check;

ALTER TABLE tasks 
ADD CONSTRAINT tasks_status_check 
CHECK (status IN ('pending', 'in_progress', 'review', 'completed', 'on_hold', 'cancelled'));
```

#### 3.2 모델 수정
- `lib/features/tasks/data/models/task_model.dart`
  - TaskStatus enum에 review 추가
  - JsonValue로 'review' 매핑

#### 3.3 Repository 수정
- `lib/features/tasks/data/repositories/task_repository.dart`
  - _$TaskStatusEnumMap에 review 매핑 추가
  - updateTaskStatus 메서드 수정: enum을 문자열로 변환

#### 3.4 UI 업데이트
- **칸반보드** (`lib/features/tasks/presentation/screens/tasks_screen.dart`)
  - 검수 컬럼 추가 (보라색, fact_check 아이콘)
  - 진행중과 완료 사이에 위치

- **Helper 메서드 수정**
  - `task_detail_screen.dart`: _getStatusText, _getStatusIcon, _getStatusColor에 review 케이스 추가
  - `task_add_screen.dart`: 동일한 helper 메서드 수정
  - `dashboard_screen.dart`: switch 문에 review 케이스 추가
  - `task_card.dart`: _buildStatusIndicator에 review 케이스 추가

#### 3.5 Provider 수정
- `lib/features/tasks/presentation/providers/task_provider.dart`
  - groupedTasksProvider에 TaskStatus.review 추가

---

## 4. 컴파일 오류 수정

### 문제점
- TaskStatus enum에 review 추가 후 여러 파일에서 exhaustive switch 오류 발생

### 해결 방법
- 모든 switch 문에 TaskStatus.review 케이스 추가
- 영향받은 파일:
  - dashboard_screen.dart
  - tasks_screen.dart
  - task_card.dart

---

## 5. 검수 상태 저장 오류 수정

### 문제점
- 할일을 검수 상태로 변경 후 저장 시 데이터베이스 오류 발생

### 원인
- 데이터베이스 CHECK 제약 조건에 'review' 값이 누락됨
- updateTaskStatus 메서드에서 enum을 직접 사용

### 해결 방법
1. CHECK 제약 조건 업데이트 (위 3.1 참조)
2. updateTaskStatus 메서드에서 enum을 문자열로 변환하도록 수정

---

## 테스트 완료 항목
- ✅ 할일 삭제 기능 정상 작동
- ✅ 프로젝트 필터링 (전체/상태별) 정상 작동
- ✅ 할일 검수 상태 추가 및 표시
- ✅ 칸반보드에서 검수 컬럼 표시
- ✅ 검수 상태 변경 및 저장 정상 작동

## 다음 작업 제안
1. 검수 완료 시 자동으로 완료 상태로 전환하는 워크플로우 구현 검토
2. 검수자 지정 기능 추가 검토
3. 검수 코멘트 기능 추가 검토